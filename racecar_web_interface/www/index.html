<!DOCTYPE html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/dashboard.css">

    <title>Login</title>
</head>
<body style="background-color: lightblue;">
  <div class="login-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(211, 211, 211, 0.75)">
    <h1>Connexion au Racecar</h1>
    <form id="loginForm" style="text-align: right;">
        <label for="username">Nom d'utilisateur</label>
        <input type="text" id="username" name="username" required>
        <br>
        <label for="ipAddress"> Adresse IP: </label>
        <input type="text" id="ipAddress" name="ipAddress" placeholder="127.0.0.1" required>
        <br>
        <input type="submit" value="Soumettre">
    </form>
  </div>
<!-- Main layout END-->

<!-- JavaScript, import frameworks -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="js/jquery-3.3.1.slim.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/roslib.min.js"></script> <!-- rosbridge -->

<script>

// Define some global variables
var rbServer = null;

document.getElementById("loginForm").addEventListener("submit", function(event) {
  event.preventDefault();
  connectROS();
});

// Define the timeout variable in the outer scope
const timeout = 500;

function connectROS() {
  // Disable the submit button to prevent further connection attempt
  document.querySelector('input[type="submit"]').disabled = true;
  // This function connects to the rosbridge server
  const ipAddress = document.getElementById("ipAddress").value;
  const ipRegex = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/;

  if (!ipRegex.test(ipAddress)) {
    alert("Invalid IP address format. Please enter a valid IP address.");
    // Re-enable the submit button for re-submission
    document.querySelector('input[type="submit"]').disabled = false;
    return;
  }
  var enableSubmit = true;
  // Use an XMLHttpRequest for the reachability check
  checkServerReachability(ipAddress, function (isReachable) {

    if (isReachable) {
      enableSubmit = false;
      // If the server is reachable, connect to the rosbridge server
      rbServer = new ROSLIB.Ros({
        url: 'ws://' + ipAddress + ':9090'
      });

      rbServer.on('connection', function () {
        console.log('Connected to websocket server.');
        // Redirect to the second page
        sessionStorage.setItem('username', document.getElementById("username").value);
        sessionStorage.setItem('ipAddress', ipAddress);
        window.location.href = 'MainPage.html';
      });

      rbServer.on('error', function (error) {
        console.log('Error connecting to websocket server: ', error);
        // Re-enable the submit button for re-submission
        document.querySelector('input[type="submit"]').disabled = false;
      });

      rbServer.on('close', function () {
        console.log('Connection to websocket server closed.');
        // Re-enable the submit button for re-submission
        document.querySelector('input[type="submit"]').disabled = false;
      });

    } else if (enableSubmit){
      // The server is not reachable
      alert("The server at IP address " + ipAddress + " is not reachable. Please check the IP address and network connection.");
      // Re-enable the submit button for re-submission
      document.querySelector('input[type="submit"]').disabled = false;
    }
  });
}


function checkServerReachability(ipAddress, callback) {
  var wsUrl = 'ws://' + ipAddress + ':9090';
  var ws = new WebSocket(wsUrl);

  // Set a timeout for the WebSocket connection attempt
  var timer = setTimeout(function () {
    ws.close(); // Close the connection if it's taking too long
    callback(false); // Indicate that the server is not reachable
  }, timeout);

  ws.onopen = function () {
    clearTimeout(timer); // Cancel the timeout since the connection succeeded
    ws.close(); // Close the WebSocket connection
    callback(true); // Indicate that the server is reachable
  };
  
  ws.onclose = function () {
    clearTimeout(timer); // Cancel the timeout since the connection was closed
    callback(false); // Indicate that the server is not reachable
  };
}     

</script>
</body>
</html>